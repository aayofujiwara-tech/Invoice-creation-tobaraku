# AA Group ええすまい請求自動化システム — Claude Code 開発指示書

---

## ■ 最初にやること：参考フォルダの作成

**開発を始める前に、まず以下のコマンドで `参考/` フォルダを作成してください：**

```bash
mkdir -p 参考
```

作成したら「`参考/` フォルダを作成しました。実データファイルを追加してください。」と報告して、ユーザーがファイルを追加するのを待ってください。

ユーザーが以下のファイルを追加します：
- ええすまい請求_セレーネ__.xlsx
- ええすまい請求_パシフィック_.xlsx
- ええすまい請求_ルネッサンス__.xlsx
- 食費管理表_セレーネ_.xlsx
- 食費管理表_パシフィック_.xlsx
- 食費管理表_ルネッサンス_.xlsx
- ニック請求.xlsx
- ニック料金表.png

**ファイルが揃ったことを確認してから、次に進んでください。**

---

## ■ 絶対に守ること：データファースト原則

> **⚠️ 最重要ルール ⚠️**
>
> **コードを1行も書く前に、`参考/` フォルダ内の全ファイル・全シートを徹底的に解析すること。**
>
> このプロンプトに書かれたファイル構造の説明はあくまで「ガイド」であり、**実データが常に正**です。
> プロンプトの記述と実データが矛盾する場合は、**必ず実データに従ってください。**
>
> - 全Excelファイルのシート一覧、行数、列数、セル結合、数式、書式を確認すること
> - 請求書テンプレートはセル単位で配置を正確に読み取ること
> - 月別集約シート（RX.X）は最低3ヶ月分を比較して、パターンの変動を把握すること
> - ニック料金表.png は画像として読み取り、セット別単価を正確に把握すること
> - 食費管理表は入居者ごとの3行1セット構造を実データで確認すること
>
> **解析結果を `解析レポート.md` として出力し、ユーザーに確認を取ってから設計・実装に進むこと。**

---

## ■ プロジェクト概要

株式会社AA（大阪市西淀川区）が運営する3拠点のサービス付き高齢者住宅（ええすまい）の月次請求業務を自動化するプログラムを作成してください。

現在すべて手作業（Excel転記）で行っている以下の流れを、Pythonスクリプトで自動化します：

```
食費管理表 ＋ ニック請求カレンダー → 請求集約シート(RX.X) → 請求書・領収書・合算明細書
```

---

## ■ 参考フォルダ構成（期待されるファイル）

`参考/` フォルダに以下の実データが入ります。**まず全ファイルを解析してから設計に入ってください。**

```
参考/
├── ええすまい請求_セレーネ__.xlsx    ← 請求マスター（セレーネ）
├── ええすまい請求_パシフィック_.xlsx  ← 請求マスター（パシフィック）
├── ええすまい請求_ルネッサンス__.xlsx ← 請求マスター（ルネッサンス）
├── 食費管理表_セレーネ_.xlsx
├── 食費管理表_パシフィック_.xlsx      ← 3拠点の食事提供カレンダー
├── 食費管理表_ルネッサンス_.xlsx
├── ニック請求.xlsx                    ← オムツ等の○カレンダー
└── ニック料金表.png                   ← ニックのセット別単価表（画像）
```

---

## ■ 既存ファイル構造の詳細（解析済み）

### 1. 請求マスター（ええすまい請求_〇〇.xlsx）— 最も重要

各拠点のメインファイル。以下のシートを持つ：

| シート名 | 役割 |
|----------|------|
| `入居者` or `利用者` | 居室番号⇔利用者名のマスタ（居室は数字`608`やアルファベット`2A`,`5B`等混在） |
| `すまい請求書` | **請求書テンプレート**（1人分、セル参照で自動表示） |
| `領収書` / `領収書（自動）` | **領収書テンプレート**（同上） |
| `合算請求書` / `合算明細書` | **合算明細テンプレート**（ええすまい＋ええかいご＋ええかんご合計） |
| `R8.1`, `R7.12`, `R7.11`... | **月別請求集約シート**（これが計算の核心） |

#### 月別請求集約シート（RX.X）の構造:

```
Row 1: 対象月末日（例: 2026-01-31）
Row 2: ヘッダー
  A:居室  B:利用者名  C:分納残  D:家賃  E:管理費  F:共益費  G:水道料金
  H:定額光熱費  I:食事  J:調整額  K:オムツ  L:日用品  M:分割支払い
  N:事務手数料  O:デイサービス  P:福祉用具  Q:しろくま薬局
  R:往診診療費  S:サポート費  T:その他
Row 3〜: 各入居者のデータ（居室番号順、空室は居室番号のみ）
```

**列D〜Hが固定費（来月分前払い）、列I以降が当月実費。**

#### 請求書テンプレート（すまい請求書）の構造:

```
A1: "ええすまい請求書" or "ええすまい御請求書"
A2: 利用者名  J2: 発行日  M2: 対象月（例: R8.1）
A4: 拠点名（ええすまい）  F4: 居室番号
C6: ご請求金額（合計）

A9: "内容"  C9: "単価"  E9: "数量"  G9: "小計"  I9: "備考"
A10: 家賃      C10: 40000  E10: 1か月  G10: 40000  I10: 月番号
A11: 管理費    C11: 5000   ...
A12: 共益費    C12: 5000
A13: 水道料金  C13: 2000
A14: 定額光熱費 C14: 10000
A15: 食事      C15: (月額)
A16: 調整額
A17: オムツ
A18: 日用品
A19: 分割支払い
A20: 事務手数料
（以降、デイサービス、しろくま薬局等が続く場合あり）
```

#### 領収書テンプレートの構造:

```
B1: "領　収　書"
B4: 利用者名  D4: "様"
C6: 金額
B7: "但し　家賃、共益費、管理費、水道代、自費分として"
C9: "株式会社AA"
C10: "〒555-0022"
C11: "大阪市西淀川区柏里2-9-3-102"
C12: "TEL・FAX 06-4400-2901"
```

#### 合算明細書テンプレートの構造:

```
A1: "ご利用金額のお知らせ"
A2: 利用者名  H2: 発行日
A4: 拠点名  F4: 居室番号
D7: 合計金額

A10: "ええすまい"  C10: 請求額  E10: 支払期限
A11: "ええかいご"  C11: 請求額  E11: 支払期限
A12: "ええかんご"  C12: 請求額  E12: 支払期限

A18: 振込先（住信SBIネット銀行 法人第一支店 普通 2555848）
```

---

### 2. 食費管理表（食費管理表_〇〇.xlsx）

月別シート（`R8.1`, `R7.12`...）に入居者ごとの日別食事提供記録。

```
Row 1: 年, 月
Row 2: 部屋, 利用者名, 食事形態, [日付1, 日付2, ... 日付31]
Row 3: 曜日行

各入居者は3行1セット:
  Row N:   居室番号, 利用者名, 食事形態, D="朝食", [1/0の日別フラグ]
  Row N+1:                              D="昼食", [1/0の日別フラグ]
  Row N+2:                              D="夕食", [1/0の日別フラグ]
```

**ポイント:**
- 日付列は E列〜AI列（最大31日）
- 1.0 = 提供あり、0.0 or 空白 = 提供なし
- 「提供なし」「自炊」と食事形態に書かれている人は全日0
- デイサービス日は昼食が0になるパターンが多い

**食費単価:** 1食550円（税込）が基本。月の食数×550＝食費月額。
（この単価はニック料金表等から推定。実装時に設定で変更可能にすること）

---

### 3. ニック請求（ニック請求.xlsx）

シート名が年月（例: `20261` = 2026年1月）。

```
Row 1: 月初日
Row 2: ヘッダー（ステーション/病室, 利用者ID, 氏名, セット, 1日〜31日）
Row 3〜: 各利用者

各利用者は1〜2行:
  Row N: ステーション, ID, "姓 名", セット種別, [○/空白の日別フラグ]
  Row N+1: (セット種別が追加の場合もう1行)
```

**セット種別:** `福`, `Ａ`, `Ｂ`, `Ｃ`, `Ｄ`, `Ｅ`, `Ｆ`, `ふ`, `用`（全角文字）
- 1人が複数セットを持つ場合がある（例: `Ｄ`行と`福`行の2行）
- `○`（全角丸）= その日に利用あり
- 日数 × セット単価 ＝ 月額

**セット単価:** `ニック料金表.png`を参照して読み取ること。画像が読めない場合は以下を暫定値として使用：

| セット | 内容（推定） | 日額（税込） |
|--------|-------------|-------------|
| 福 | 福祉オムツ基本 | 要確認 |
| Ａ | セットA | 要確認 |
| Ｂ | セットB | 要確認 |
| Ｃ | セットC | 要確認 |
| Ｄ | セットD | 要確認 |
| Ｅ | セットE | 要確認 |
| Ｆ | セットF | 要確認 |
| ふ | 布団リース等 | 要確認 |
| 用 | 日用品 | 要確認 |

→ **まず `ニック料金表.png` を読んで単価を確定してください。**

---

### 4. 名寄せの課題

利用者名の表記が**ファイル間でブレ**があります：

| 食費管理表 | ニック請求 | 請求マスター |
|-----------|-----------|-------------|
| 加藤敬子 | 加藤 敬子 | 加藤敬子 / 加藤恵子 |
| 荒木のり子 | 荒木 のり子 | 荒木のり子 |
| 北村繫弘 | 北村 繁弘 | 北村繁弘 |

→ **居室番号をプライマリキーとし、名前はファジーマッチで補助的に使うこと。**
→ ただし同一人物が拠点間を異動するケースあり（例: 上村春子がセレーネ801→パシフィック403）

---

## ■ 計算ロジック

### 一般入居者（分納残=0 or なし）

```
請求額 = 家賃 + 管理費 + 共益費 + 水道 + 光熱費 + 食事 + オムツ + 日用品
        + デイ + しろくま薬局 + 往診 + 事務手数料 + その他
```

### 福祉受給者（分納残 > 0）

```
上限額 = 110,000円（固定）
固定費 = 家賃 + 管理費 + 共益費 + 水道 + 光熱費
残枠 = 上限額 - 固定費 - 食事代
調整額 = -(オムツ + 日用品 + デイ + 薬局 + 往診 + その他 - 残枠)
        ※残枠で賄えない分をマイナスで相殺し、請求額を上限に収める
分割支払い = 10,000円/月（分納残から差し引き）
```

**調整額（J列）がマイナスの場合 → 福祉の上限逆算パターン。**
これにより請求合計が110,000円に収まるよう自動調整。

---

## ■ 作成するプログラムの要件

### アーキテクチャ

```
Python 3.10+
├── config.yaml          ← 拠点設定、単価、上限額等
├── main.py              ← メイン実行スクリプト
├── readers/
│   ├── meal_reader.py   ← 食費管理表パーサー
│   ├── nick_reader.py   ← ニック請求パーサー
│   └── master_reader.py ← 請求マスター読取
├── calc/
│   ├── meal_calc.py     ← 食費計算（食数×単価）
│   ├── nick_calc.py     ← ニック計算（日数×セット単価）
│   └── billing.py       ← 請求集約＋調整額計算
├── writers/
│   ├── summary_writer.py  ← RX.X集約シート書込
│   ├── invoice_writer.py  ← 請求書生成
│   ├── receipt_writer.py  ← 領収書生成
│   └── combined_writer.py ← 合算明細書生成
└── utils/
    ├── name_match.py    ← 名寄せユーティリティ
    └── helpers.py
```

### 実行フロー

```bash
python main.py --month 2026-01 --input-dir ./data --output-dir ./output
```

1. **読取フェーズ**: 食費管理表・ニック請求から対象月データを抽出
2. **計算フェーズ**: 食費月額・ニック月額を算出
3. **集約フェーズ**: 請求マスターの該当月RX.Xシートに値を反映（or 新規シート作成）
4. **出力フェーズ**: 請求書・領収書・合算明細書をExcelファイルとして生成

### 出力ファイル

```
output/2026-01/
├── セレーネ/
│   ├── RX.X集約シート（既存ファイル更新 or 新規）
│   ├── 請求書_荒木のり子_R8.1.xlsx
│   ├── 領収書_荒木のり子_R8.1.xlsx
│   └── ...
├── パシフィック/
│   └── ...
└── ルネッサンス/
    └── ...
```

### 重要な実装方針

1. **既存テンプレートを尊重**: 請求書・領収書のレイアウトは既存ファイルのセル配置を完全に再現すること
2. **openpyxlで実装**: Excelの書式・罫線・印刷設定をできるだけ保持
3. **設定ファイルで単価管理**: 食費単価、ニックセット単価、福祉上限額はconfig.yamlで外出し
4. **段階的に開発**: まず食費計算→ニック計算→集約→請求書出力の順で
5. **検証機能**: 過去月のRX.Xシートと計算結果を突合して正確性を確認できるテストを用意
6. **手入力項目の扱い**: しろくま薬局、往診、デイサービス等の外部請求は手入力前提。食費とニックの自動計算が主目的

---

## ■ 開発の進め方（推奨手順）

### Phase 0: データ徹底解析（最重要 — ここを飛ばさないこと）

> **このPhaseが完了するまで、設計もコーディングも一切行わないこと。**

1. `参考/`フォルダの**全ファイル・全シート**をopenpyxlで読み込み、以下を調査：
   - 各シートの行数・列数・ヘッダー行の内容
   - セル結合の有無と範囲
   - 数式が入っているセル（計算ロジックの手がかり）
   - 書式・罫線・印刷範囲の設定
2. `ニック料金表.png` を画像として読み、セット別単価を正確に書き出す
3. 請求マスターの月別シート（RX.X）を**最低3ヶ月分比較**し：
   - 列構成が月ごとに変わっていないか
   - 入退居に伴う行の増減パターン
   - 福祉入居者の調整額計算を逆算で検証
4. 食費管理表の食数を手計算し、請求マスターの食事列の値と一致するか突合
5. ニック請求の○日数を手計算し、請求マスターのオムツ・日用品列の値と一致するか突合
6. **`解析レポート.md` を出力**し、以下を含める：
   - 各ファイルの正確な構造（このプロンプトの記述との差異があれば明記）
   - ニック料金表から読み取った単価一覧
   - 突合結果（一致/不一致）
   - 発見した例外パターンや注意点

→ **ユーザーの確認を得てから Phase 1 に進むこと。**

### Phase 1: 読取モジュール実装
1. 食費管理表パーサーの実装（3拠点対応）— **解析で確認した実構造に基づいて**
2. ニック請求パーサーの実装 — **解析で確認した実構造に基づいて**
3. 請求マスターの読取実装
4. 各パーサーのユニットテスト（実データで検証）

### Phase 2: 計算エンジン
1. 食費月額計算（食数カウント×単価）
2. ニック月額計算（日数×セット単価）
3. 一般/福祉の請求額計算
4. **過去月データとの突合テスト**（R8.1の食事列の値と、食費管理表R8.1から計算した値が一致するか確認）
5. 全入居者・全月でズレがゼロになるまでロジックを調整

### Phase 3: 出力生成
1. RX.Xシート生成/更新
2. 請求書Excel生成（**既存テンプレートのセル配置・書式を完全再現**）
3. 領収書Excel生成
4. 合算明細書生成

---

## ■ 補足: 拠点ごとの特徴

| 拠点 | 居室番号形式 | 入居者数（直近） | 特記 |
|------|------------|----------------|------|
| セレーネ | 数字3桁（608, 703, 801...） | 5〜8名 | 最も単純な構造 |
| パシフィック | 数字3桁（108, 206, 402...） | 10〜15名 | 最も入居者が多い |
| ルネッサンス | 英数混合（2A, 2B, 5B, 6C...） | 5〜10名 | 居室番号が特殊。旧フォーマット（R7.5✕等）も混在 |

---

## ■ 質問があれば

実装中に不明点があれば、以下の優先順位で判断してください：
1. 既存の請求マスター（RX.Xシート）の実データから逆算
2. 請求書テンプレートのセル配置から推定
3. 不明な場合はTODOコメントを残して先に進む
